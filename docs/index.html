<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathQuiz Live - Interface Professeur</title>
    
    <!-- Configuration -->
    <script src="config.js"></script>
    
    <!-- MathJax Configuration et Import -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    console.log('✅ MathJax chargé !');
                }
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            min-height: 100vh;
            padding: 1.5rem;
        }

        .max-w-6xl { max-width: 72rem; margin: 0 auto; }
        .max-w-4xl { max-width: 56rem; margin: 0 auto; }
        .text-center { text-align: center; }
        .hidden { display: none; }

        .title {
            font-size: 3rem;
            font-weight: bold;
            color: white;
            margin-bottom: 1rem;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.25rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 2rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 1.5rem;
            backdrop-filter: blur(10px);
        }

        .btn {
            padding: 2rem;
            border-radius: 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            color: white;
        }

        .btn:hover { transform: scale(1.05); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .btn-green { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-yellow { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .btn-red { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .btn-gray { background: linear-gradient(135deg, #6b7280, #4b5563); }

        .quiz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .quiz-item {
            background: #f9fafb;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            transition: all 0.3s;
        }

        .quiz-item:hover { 
            border-color: #a855f7; 
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .quiz-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .quiz-actions button {
            flex: 1;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            color: white;
        }

        /* Session Live Controls */
        .session-controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .room-code-display {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .room-code {
            font-size: 3rem;
            font-weight: bold;
            letter-spacing: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .participants-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .participant-name {
            font-weight: 600;
            color: #1f2937;
        }

        .participant-status {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-connected { background: #dcfce7; color: #166534; }
        .status-disconnected { background: #fee2e2; color: #991b1b; }

        .live-game-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .live-game-controls button {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        /* Question Display */
        .current-question-display {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .question-text-large {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
            min-height: 3rem;
        }

        .answers-preview {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .answer-preview {
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .answer-red { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .answer-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .answer-yellow { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .answer-green { background: linear-gradient(135deg, #10b981, #059669); }

        .correct-answer { border: 4px solid #22c55e; }

        /* Stats */
        .live-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #f9fafb, #e5e7eb);
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Form Styles */
        .form-group { margin-bottom: 1.5rem; }
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Status Messages */
        .status-message {
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .title { font-size: 2rem; }
            .room-code { font-size: 2rem; }
            .answers-preview { grid-template-columns: 1fr; }
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Page d'accueil -->
        <div id="home" class="container">
            <div class="max-w-6xl">
                <div class="text-center">
                    <h1 class="title">MathQuiz Live</h1>
                    <p class="subtitle">Quiz interactifs en temps réel pour vos cours de mathématiques</p>
                </div>

                <div id="connectionStatus" class="status-message status-info hidden">
                    <span id="connectionText">🔗 Connexion à Supabase...</span>
                </div>

                <div class="grid">
                    <button class="btn btn-green" onclick="showCreateView()">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">➕</div>
                        <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Créer un Quiz</h3>
                        <p style="opacity: 0.8;">Nouvelles questions</p>
                    </button>
                    
                    <button class="btn btn-yellow" onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📁</div>
                        <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Charger XML</h3>
                        <p style="opacity: 0.8;">Importer questions</p>
                    </button>
                    <input type="file" id="fileInput" accept=".xml" style="display: none;" onchange="loadQuestionsFromFile(event)">
                    
                    <button class="btn btn-purple" onclick="downloadExampleXML()">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📄</div>
                        <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Exemple XML</h3>
                        <p style="opacity: 0.8;">Télécharger modèle</p>
                    </button>
                    
                    <button class="btn btn-blue" onclick="showStudentAccess()">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📱</div>
                        <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Accès Élèves</h3>
                        <p style="opacity: 0.8;">URL & QR Code</p>
                    </button>
                </div>

                <div class="card">
                    <h2 style="font-size: 1.5rem; font-weight: bold; color: #1f2937; margin-bottom: 1.5rem;">
                        🏆 Mes Quiz
                    </h2>
                    
                    <div id="quizList" class="quiz-grid">
                        <!-- Quiz seront ajoutés ici -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Live -->
        <div id="liveSession" class="container hidden">
            <div class="max-w-6xl">
                <!-- Header avec code de salle -->
                <div class="session-controls">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                        <h1 style="font-size: 1.5rem; color: #1f2937; font-weight: bold;">Session Live</h1>
                        <button class="btn-red" style="padding: 0.5rem 1rem; border-radius: 0.5rem;" onclick="endSession()">🔚 Terminer</button>
                    </div>

                    <div class="room-code-display">
                        <h2 style="font-size: 1.2rem; margin-bottom: 0.5rem; opacity: 0.9;">Code de salle</h2>
                        <div class="room-code" id="roomCodeDisplay">ABC123</div>
                        <p style="opacity: 0.8;">Les élèves peuvent rejoindre sur : <strong id="studentUrlDisplay"></strong></p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <!-- Participants -->
                        <div>
                            <h3 style="font-weight: bold; margin-bottom: 1rem; color: #1f2937;">
                                👥 Participants (<span id="participantCount">0</span>)
                            </h3>
                            <div id="participantsList" class="participants-list">
                                <div style="text-align: center; color: #6b7280; padding: 2rem;">
                                    En attente des élèves...
                                </div>
                            </div>
                        </div>

                        <!-- Contrôles de jeu -->
                        <div>
                            <h3 style="font-weight: bold; margin-bottom: 1rem; color: #1f2937;">
                                🎮 Contrôles
                            </h3>
                            
                            <div class="live-stats">
                                <div class="stat-card">
                                    <div class="stat-number" id="totalQuestions">0</div>
                                    <div class="stat-label">Questions</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="currentQuestionNum">0</div>
                                    <div class="stat-label">Question actuelle</div>
                                </div>
                            </div>

                            <div class="live-game-controls">
                                <button id="startQuizBtn" class="btn-green" onclick="startLiveQuiz()">
                                    🚀 Démarrer le Quiz
                                </button>
                                <button id="nextQuestionBtn" class="btn-blue hidden" onclick="nextQuestion()">
                                    ➡️ Question Suivante
                                </button>
                                <button id="pauseBtn" class="btn-yellow hidden" onclick="pauseQuiz()">
                                    ⏸️ Pause
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Question Actuelle -->
                <div id="currentQuestionDisplay" class="current-question-display hidden">
                    <h3 style="color: #6b7280; margin-bottom: 1rem;">Question <span id="questionNumber">1</span></h3>
                    <div id="currentQuestionText" class="question-text-large"></div>
                    
                    <div class="answers-preview">
                        <div class="answer-preview answer-red" id="answerPreview0">A. Réponse 1</div>
                        <div class="answer-preview answer-blue" id="answerPreview1">B. Réponse 2</div>
                        <div class="answer-preview answer-yellow" id="answerPreview2">C. Réponse 3</div>
                        <div class="answer-preview answer-green" id="answerPreview3">D. Réponse 4</div>
                    </div>

                    <div style="margin-top: 1rem; color: #6b7280;">
                        ⏱️ Temps: <span id="questionTime">30</span>s
                    </div>
                </div>
            </div>
        </div>

        <!-- Creation de quiz (interface simplifiée) -->
        <div id="create" class="container hidden">
            <div class="max-w-4xl">
                <div class="card">
                    <h1 style="font-size: 2rem; color: #1f2937; margin-bottom: 2rem;">Créer un Quiz Express</h1>
                    
                    <div class="form-group">
                        <label class="form-label">Titre du quiz</label>
                        <input type="text" id="quickQuizTitle" class="form-input" placeholder="Ex: Équations du Second Degré" value="Quiz Express">
                    </div>

                    <div style="text-align: center;">
                        <button class="btn btn-green" style="padding: 1rem 2rem; margin: 1rem;" onclick="createQuickQuiz('algebra')">
                            📐 Quiz Algèbre (10 questions)
                        </button>
                        <button class="btn btn-blue" style="padding: 1rem 2rem; margin: 1rem;" onclick="createQuickQuiz('geometry')">
                            📏 Quiz Géométrie (10 questions)
                        </button>
                        <button class="btn btn-purple" style="padding: 1rem 2rem; margin: 1rem;" onclick="createQuickQuiz('functions')">
                            📈 Quiz Fonctions (10 questions)
                        </button>
                    </div>

                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn-gray" style="padding: 0.75rem 2rem; border-radius: 0.5rem;" onclick="showHomeView()">
                            ← Retour
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Accès élèves -->
        <div id="studentAccess" class="container hidden">
            <div class="max-w-4xl">
                <div class="card text-center">
                    <h1 style="font-size: 2rem; color: #1f2937; margin-bottom: 2rem;">📱 Accès Élèves</h1>
                    
                    <div style="background: #f9fafb; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem;">
                        <h3 style="color: #1f2937; margin-bottom: 1rem;">URL pour les élèves :</h3>
                        <div style="background: white; padding: 1rem; border-radius: 0.5rem; font-family: monospace; font-size: 1.1rem; word-break: break-all; border: 2px dashed #8b5cf6;">
                            https://adatil.github.io/mathquiz-supabase/student.html
                        </div>
                        <button class="btn btn-blue" style="margin-top: 1rem; padding: 0.75rem 1.5rem;" onclick="copyStudentUrl()">
                            📋 Copier l'URL
                        </button>
                    </div>

                    <div style="background: #f9fafb; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem;">
                        <h3 style="color: #1f2937; margin-bottom: 1rem;">Instructions pour les élèves :</h3>
                        <ol style="text-align: left; color: #4b5563; line-height: 1.8;">
                            <li>Aller sur l'URL ci-dessus avec leur téléphone/tablette</li>
                            <li>Entrer le <strong>code de salle</strong> (6 caractères)</li>
                            <li>Saisir leur <strong>prénom</strong></li>
                            <li>Cliquer sur <strong>"Rejoindre le Quiz"</strong></li>
                        </ol>
                    </div>

                    <button class="btn-gray" style="padding: 0.75rem 2rem; border-radius: 0.5rem;" onclick="showHomeView()">
                        ← Retour
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // État global de l'application
        let appState = {
            currentView: 'home',
            quizzes: [],
            currentSession: null,
            currentQuiz: null,
            participants: [],
            currentQuestionIndex: 0,
            sessionStatus: 'idle', // idle, waiting, active, paused, finished
            ws: null,
            teacherId: 'teacher_' + Date.now()
        };

        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Démarrage MathQuiz Live');
            
            try {
                // Attendre que la configuration soit chargée
                await waitForConfig();
                
                // Initialiser Supabase
                if (window.initializeSupabase) {
                    window.initializeSupabase();
                }

                // Charger les quiz existants
                await loadQuizzes();
                
                // Afficher le status de connexion
                showConnectionStatus('✅ Connecté à Supabase', 'success');
                
                console.log('✅ Application initialisée');
            } catch (error) {
                console.error('❌ Erreur d\'initialisation:', error);
                showConnectionStatus('❌ Erreur de connexion', 'error');
            }
        });

        async function waitForConfig() {
            return new Promise((resolve) => {
                const checkConfig = () => {
                    if (window.CONFIG && window.SessionAPI) {
                        resolve();
                    } else {
                        setTimeout(checkConfig, 100);
                    }
                };
                checkConfig();
            });
        }

        function showConnectionStatus(message, type) {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            statusEl.className = `status-message status-${type}`;
            textEl.textContent = message;
            statusEl.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 3000);
            }
        }

        // Navigation
        function showView(viewName) {
            ['home', 'liveSession', 'create', 'studentAccess'].forEach(view => {
                document.getElementById(view).classList.add('hidden');
            });
            document.getElementById(viewName).classList.remove('hidden');
            appState.currentView = viewName;
        }

        function showHomeView() {
            showView('home');
            if (appState.ws) {
                appState.ws.disconnect();
            }
            appState.currentSession = null;
        }

        function showCreateView() {
            showView('create');
        }

        function showStudentAccess() {
            showView('studentAccess');
            document.getElementById('studentUrlDisplay').textContent = window.CONFIG?.STUDENT_URL || 'URL non disponible';
        }

        // Gestion des quiz
        async function loadQuizzes() {
            try {
                // Pour le moment, utiliser des quiz exemple
                appState.quizzes = [
                    {
                        id: 'quiz_algebra_1',
                        title: 'Équations du Second Degré',
                        subject: 'Algèbre',
                        totalQuestions: 10,
                        questions: generateAlgebraQuestions()
                    },
                    {
                        id: 'quiz_geometry_1', 
                        title: 'Géométrie Plane',
                        subject: 'Géométrie',
                        totalQuestions: 8,
                        questions: generateGeometryQuestions()
                    }
                ];
                
                renderQuizList();
            } catch (error) {
                console.error('Erreur lors du chargement des quiz:', error);
            }
        }

        function renderQuizList() {
            const container = document.getElementById('quizList');
            container.innerHTML = '';

            appState.quizzes.forEach(quiz => {
                const div = document.createElement('div');
                div.className = 'quiz-item';
                div.innerHTML = `
                    <h3 style="font-weight: bold; font-size: 1.125rem; color: #1f2937; margin-bottom: 0.5rem;">${quiz.title}</h3>
                    <p style="color: #6b7280; margin-bottom: 0.5rem;">${quiz.subject} • ${quiz.totalQuestions} questions</p>
                    <div class="quiz-actions">
                        <button class="btn-green" onclick="startLiveSession('${quiz.id}')">🔴 Session Live</button>
                        <button class="btn-blue" onclick="exportQuizToXML('${quiz.id}')">📁 Export</button>
                        <button class="btn-red" onclick="deleteQuiz('${quiz.id}')">🗑️ Suppr.</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Sessions Live
        async function startLiveSession(quizId) {
            try {
                showConnectionStatus('🔄 Création de la session...', 'info');
                
                const quiz = appState.quizzes.find(q => q.id === quizId);
                if (!quiz) {
                    throw new Error('Quiz non trouvé');
                }

                // Créer une session via l'API
                const sessionData = await window.SessionAPI.createSession(quizId, appState.teacherId);
                
                appState.currentSession = sessionData.session;
                appState.currentQuiz = quiz;
                appState.sessionStatus = 'waiting';
                appState.currentQuestionIndex = 0;
                appState.participants = [];

                // Connecter WebSocket
                connectWebSocket();

                // Afficher l'interface de session
                showView('liveSession');
                updateSessionDisplay();
                
                showConnectionStatus('✅ Session créée !', 'success');
                
            } catch (error) {
                console.error('Erreur création session:', error);
                showConnectionStatus('❌ Erreur: ' + error.message, 'error');
            }
        }

        function connectWebSocket() {
            if (!appState.currentSession || !window.wsManager) return;

            const sessionId = appState.currentSession.id;
            const userType = 'teacher';
            const userId = appState.teacherId;

            window.wsManager.connect(sessionId, userType, userId);

            // Écouter les événements WebSocket
            window.wsManager.on('connected', () => {
                console.log('✅ WebSocket connecté');
            });

            window.wsManager.on('user_joined', (data) => {
                if (data.userType === 'student') {
                    console.log('👨‍🎓 Nouvel élève connecté:', data.userId);
                    updateParticipants();
                }
            });

            window.wsManager.on('user_left', (data) => {
                if (data.userType === 'student') {
                    console.log('👋 Élève déconnecté:', data.userId);
                    updateParticipants();
                }
            });

            window.wsManager.on('student_answer', (data) => {
                console.log('📝 Réponse reçue:', data);
                // Traiter la réponse de l'élève
                updateParticipants();
            });

            appState.ws = window.wsManager;
        }

        function updateSessionDisplay() {
            if (!appState.currentSession || !appState.currentQuiz) return;

            // Code de salle
            document.getElementById('roomCodeDisplay').textContent = appState.currentSession.room_code;
            document.getElementById('studentUrlDisplay').textContent = window.CONFIG?.STUDENT_URL || 'URL non disponible';
            
            // Stats
            document.getElementById('totalQuestions').textContent = appState.currentQuiz.totalQuestions;
            document.getElementById('currentQuestionNum').textContent = appState.currentQuestionIndex;
            
            // Contrôles selon le statut
            updateGameControls();
        }

        function updateGameControls() {
            const startBtn = document.getElementById('startQuizBtn');
            const nextBtn = document.getElementById('nextQuestionBtn');
            const pauseBtn = document.getElementById('pauseBtn');

            // Reset
            [startBtn, nextBtn, pauseBtn].forEach(btn => btn.classList.add('hidden'));

            switch (appState.sessionStatus) {
                case 'waiting':
                    startBtn.classList.remove('hidden');
                    startBtn.disabled = appState.participants.length === 0;
                    break;
                case 'active':
                    nextBtn.classList.remove('hidden');
                    pauseBtn.classList.remove('hidden');
                    break;
                case 'paused':
                    startBtn.classList.remove('hidden');
                    startBtn.textContent = '▶️ Reprendre';
                    break;
            }
        }

        async function updateParticipants() {
            if (!appState.currentSession) return;

            try {
                const response = await window.SessionAPI.getParticipants(appState.currentSession.id);
                appState.participants = response.participants || [];
                
                renderParticipants();
                updateGameControls();
                
            } catch (error) {
                console.error('Erreur mise à jour participants:', error);
            }
        }

        function renderParticipants() {
            const container = document.getElementById('participantsList');
            const countEl = document.getElementById('participantCount');
            
            countEl.textContent = appState.participants.length;

            if (appState.participants.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 2rem;">
                        En attente des élèves...
                    </div>
                `;
                return;
            }

            container.innerHTML = appState.participants.map(participant => `
                <div class="participant-item">
                    <span class="participant-name">${participant.student_name}</span>
                    <div>
                        <span class="participant-status ${participant.is_connected ? 'status-connected' : 'status-disconnected'}">
                            ${participant.is_connected ? 'Connecté' : 'Déconnecté'}
                        </span>
                        <span style="margin-left: 0.5rem; font-weight: bold; color: #8b5cf6;">
                            ${participant.score} pts
                        </span>
                    </div>
                </div>
            `).join('');
        }

        async function startLiveQuiz() {
            try {
                if (!appState.currentSession || !appState.currentQuiz) return;

                appState.sessionStatus = 'active';
                appState.currentQuestionIndex = 0;

                // Démarrer la session via API
                await window.SessionAPI.startQuiz(appState.currentSession.id);

                // Envoyer la première question via WebSocket
                const question = appState.currentQuiz.questions[0];
                window.wsManager.send({
                    type: 'start_quiz',
                    question: question,
                    questionNumber: 1,
                    totalQuestions: appState.currentQuiz.totalQuestions
                });

                // Afficher la question
                displayCurrentQuestion();
                updateSessionDisplay();

                console.log('🚀 Quiz démarré');
                
            } catch (error) {
                console.error('Erreur démarrage quiz:', error);
                showConnectionStatus('❌ Erreur: ' + error.message, 'error');
            }
        }

        function displayCurrentQuestion() {
            const question = appState.currentQuiz.questions[appState.currentQuestionIndex];
            if (!question) return;

            document.getElementById('currentQuestionDisplay').classList.remove('hidden');
            document.getElementById('questionNumber').textContent = appState.currentQuestionIndex + 1;
            document.getElementById('currentQuestionText').innerHTML = question.question;
            document.getElementById('questionTime').textContent = question.time || 30;

            // Afficher les réponses
            question.options.forEach((option, index) => {
                const el = document.getElementById(`answerPreview${index}`);
                el.innerHTML = `${String.fromCharCode(65 + index)}. ${option}`;
                
                // Marquer la bonne réponse
                if (index === question.correct) {
                    el.classList.add('correct-answer');
                } else {
                    el.classList.remove('correct-answer');
                }
            });

            // Rerender MathJax
            setTimeout(() => {
                if (window.MathJax && MathJax.typesetPromise) {
                    MathJax.typesetPromise();
                }
            }, 100);
        }

        function nextQuestion() {
            if (appState.currentQuestionIndex < appState.currentQuiz.questions.length - 1) {
                appState.currentQuestionIndex++;
                
                const question = appState.currentQuiz.questions[appState.currentQuestionIndex];
                
                // Envoyer via WebSocket
                window.wsManager.send({
                    type: 'next_question',
                    question: question,
                    questionNumber: appState.currentQuestionIndex + 1
                });

                displayCurrentQuestion();
                updateSessionDisplay();
                
            } else {
                // Quiz terminé
                endQuiz();
            }
        }

        function endQuiz() {
            appState.sessionStatus = 'finished';
            
            window.wsManager.send({
                type: 'quiz_finished',
                finalResults: appState.participants
            });

            alert('Quiz terminé ! 🎉');
            updateSessionDisplay();
        }

        function pauseQuiz() {
            appState.sessionStatus = 'paused';
            updateGameControls();
        }

        function endSession() {
            if (confirm('Êtes-vous sûr de vouloir terminer la session ?')) {
                if (appState.ws) {
                    appState.ws.disconnect();
                }
                showHomeView();
            }
        }

        // Création de quiz rapide
        function createQuickQuiz(subject) {
            const title = document.getElementById('quickQuizTitle').value || 'Quiz Express';
            
            let questions = [];
            switch (subject) {
                case 'algebra':
                    questions = generateAlgebraQuestions();
                    break;
                case 'geometry':
                    questions = generateGeometryQuestions();
                    break;
                case 'functions':
                    questions = generateFunctionQuestions();
                    break;
            }

            const newQuiz = {
                id: 'quiz_' + Date.now(),
                title: title + ' - ' + subject.charAt(0).toUpperCase() + subject.slice(1),
                subject: subject,
                totalQuestions: questions.length,
                questions: questions
            };

            appState.quizzes.push(newQuiz);
            renderQuizList();
            showHomeView();
            
            showConnectionStatus('✅ Quiz créé !', 'success');
        }

        // Générateurs de questions
        function generateAlgebraQuestions() {
            return [
                {
                    question: "Résoudre : $$x^2 - 5x + 6 = 0$$",
                    options: ["$$x = 2$$ et $$x = 3$$", "$$x = 1$$ et $$x = 6$$", "$$x = -2$$ et $$x = -3$$", "$$x = 0$$ et $$x = 5$$"],
                    correct: 0,
                    time: 45
                },
                {
                    question: "Développer : $$(x + 3)^2$$",
                    options: ["$$x^2 + 6x + 9$$", "$$x^2 + 3x + 9$$", "$$x^2 + 6x + 6$$", "$$x^2 + 9$$"],
                    correct: 0,
                    time: 30
                },
                {
                    question: "Factoriser : $$x^2 - 9$$",
                    options: ["$$(x-3)(x+3)$$", "$$(x-9)(x+1)$$", "$$x(x-9)$$", "$$(x-3)^2$$"],
                    correct: 0,
                    time: 30
                },
                {
                    question: "Si $$2x + 5 = 13$$, alors $$x = ?$$",
                    options: ["$$4$$", "$$6$$", "$$8$$", "$$9$$"],
                    correct: 0,
                    time: 25
                },
                {
                    question: "Quelle est la forme canonique de $$x^2 + 4x + 3$$ ?",
                    options: ["$$(x + 2)^2 - 1$$", "$$(x + 2)^2 + 3$$", "$$(x + 1)^2 + 2$$", "$$(x + 4)^2 - 1$$"],
                    correct: 0,
                    time: 40
                }
            ];
        }

        function generateGeometryQuestions() {
            return [
                {
                    question: "Dans un triangle rectangle, si $$a = 3$$ et $$b = 4$$, alors $$c = ?$$",
                    options: ["$$5$$", "$$7$$", "$$6$$", "$$8$$"],
                    correct: 0,
                    time: 30
                },
                {
                    question: "L'aire d'un cercle de rayon $$r = 5$$ cm est :",
                    options: ["$$25\\pi$$ cm²", "$$10\\pi$$ cm²", "$$5\\pi$$ cm²", "$$50\\pi$$ cm²"],
                    correct: 0,
                    time: 25
                },
                {
                    question: "La somme des angles d'un triangle est :",
                    options: ["$$180°$$", "$$360°$$", "$$90°$$", "$$270°$$"],
                    correct: 0,
                    time: 20
                }
            ];
        }

        function generateFunctionQuestions() {
            return [
                {
                    question: "Soit $$f(x) = 2x + 1$$. Calculer $$f(3)$$",
                    options: ["$$7$$", "$$6$$", "$$5$$", "$$8$$"],
                    correct: 0,
                    time: 20
                },
                {
                    question: "La dérivée de $$f(x) = x^3$$ est :",
                    options: ["$$3x^2$$", "$$x^2$$", "$$3x$$", "$$x^3$$"],
                    correct: 0,
                    time: 25
                }
            ];
        }

        // Utilitaires
        function copyStudentUrl() {
            const url = window.CONFIG?.STUDENT_URL || 'URL non disponible';
            navigator.clipboard.writeText(url).then(() => {
                showConnectionStatus('✅ URL copiée !', 'success');
            });
        }

        function deleteQuiz(quizId) {
            if (confirm('Supprimer ce quiz ?')) {
                appState.quizzes = appState.quizzes.filter(q => q.id !== quizId);
                renderQuizList();
            }
        }

        function downloadExampleXML() {
            const xml = `<?xml version="1.0" encoding="UTF-8"?>
<quiz title="Équations du Second Degré - Seconde">
    <question time="45" correct="0">
        <text>Résoudre l'équation : $$x^2 - 5x + 6 = 0$$</text>
        <option>$$x = 2$$ ou $$x = 3$$</option>
        <option>$$x = 1$$ ou $$x = 6$$</option>
        <option>$$x = -2$$ ou $$x = -3$$</option>
        <option>$$x = 0$$ ou $$x = 5$$</option>
    </question>
    
    <question time="40" correct="0">
        <text>Quelle est la forme canonique de $$f(x) = x^2 + 4x + 3$$ ?</text>
        <option>$$f(x) = (x + 2)^2 - 1$$</option>
        <option>$$f(x) = (x + 4)^2 - 1$$</option>
        <option>$$f(x) = (x + 1)^2 + 2$$</option>
        <option>$$f(x) = (x + 2)^2 + 3$$</option>
    </question>
</quiz>`;

            const blob = new Blob([xml], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'quiz-equations-exemple.xml';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportQuizToXML(quizId) {
            const quiz = appState.quizzes.find(q => q.id === quizId);
            if (!quiz) return;

            let xml = `<?xml version="1.0" encoding="UTF-8"?>\n<quiz title="${quiz.title}">\n`;
            
            quiz.questions.forEach(q => {
                xml += `    <question time="${q.time}" correct="${q.correct}">\n`;
                xml += `        <text>${q.question}</text>\n`;
                q.options.forEach(opt => {
                    xml += `        <option>${opt}</option>\n`;
                });
                xml += `    </question>\n\n`;
            });
            
            xml += `</quiz>`;

            const blob = new Blob([xml], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${quiz.title.replace(/[^a-zA-Z0-9]/g, '-')}.xml`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadQuestionsFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parser = new DOMParser();
                    const xml = parser.parseFromString(e.target.result, "text/xml");
                    
                    const quiz = parseXMLToQuiz(xml);
                    if (quiz) {
                        appState.quizzes.push(quiz);
                        renderQuizList();
                        showConnectionStatus(`✅ Quiz "${quiz.title}" chargé !`, 'success');
                    }
                } catch (error) {
                    showConnectionStatus("❌ Erreur : " + error.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function parseXMLToQuiz(xml) {
            const quizEl = xml.getElementsByTagName("quiz")[0];
            if (!quizEl) {
                throw new Error("Balise <quiz> manquante !");
            }

            const title = quizEl.getAttribute("title") || "Quiz sans titre";
            const questionEls = quizEl.getElementsByTagName("question");
            
            if (questionEls.length === 0) {
                throw new Error("Aucune question trouvée !");
            }

            const questions = [];
            for (let i = 0; i < questionEls.length; i++) {
                const qEl = questionEls[i];
                const time = parseInt(qEl.getAttribute("time")) || 30;
                const correct = parseInt(qEl.getAttribute("correct")) || 0;
                
                const textEl = qEl.getElementsByTagName("text")[0];
                if (!textEl) {
                    throw new Error(`Balise <text> manquante dans la question ${i + 1} !`);
                }
                
                const optionEls = qEl.getElementsByTagName("option");
                if (optionEls.length !== 4) {
                    throw new Error(`La question ${i + 1} doit avoir 4 options !`);
                }
                
                const options = Array.from(optionEls).map(el => el.textContent.trim());
                
                questions.push({
                    question: textEl.textContent.trim(),
                    options: options,
                    correct: correct,
                    time: time
                });
            }

            return { 
                id: 'quiz_' + Date.now(), 
                title: title, 
                subject: 'Import XML',
                totalQuestions: questions.length,
                questions: questions 
            };
        }

        // Auto-refresh des participants pendant la session
        setInterval(() => {
            if (appState.currentSession && appState.sessionStatus !== 'idle') {
                updateParticipants();
            }
        }, 5000);

    </script>
</body>
</html>
